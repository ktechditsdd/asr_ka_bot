# ASR KA Bot

Telegram-–±–æ—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∫—Ä–µ–¥–∏—Ç–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ (KA) —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π —Å 1F.

---

## üìå –û–ø–∏—Å–∞–Ω–∏–µ

**ASR KA Bot** –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–µ—Ç –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞—è–≤–æ–∫ –∫—Ä–µ–¥–∏—Ç–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞:

- –ø–æ–ª—É—á–µ–Ω–∏–µ –∑–∞—è–≤–æ–∫ –∏–∑ 1F,
- –ø—É–±–ª–∏–∫–∞—Ü–∏—è –∑–∞—è–≤–æ–∫ –≤ Telegram-–≥—Ä—É–ø–ø–µ,
- —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞—è–≤–æ–∫ –º–µ–∂–¥—É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏,
- –ø—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏–π (Approve / Reject) —Å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–º,
- –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –æ–±—Ä–∞—Ç–Ω–æ –≤ 1F,
- –∞—É–¥–∏—Ç –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏ —Å–∏—Å—Ç–µ–º—ã.

–ë–æ—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω —Å —É–ø–æ—Ä–æ–º –Ω–∞ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å, –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤.

---

## üß† –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

- **PostgreSQL ‚Äî –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã**
- FSM –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è UX, –Ω–µ –¥–ª—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
- –í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è –ø–æ –ë–î
- –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- Retry-–º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è –æ—à–∏–±–æ–∫ Telegram –∏ 1F
- –ü–æ–ª–Ω—ã–π audit-log –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π

---

## üîÑ –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –∑–∞—è–≤–∫–∏

### –°—Ç–∞—Ç—É—Å—ã –∑–∞—è–≤–∫–∏ (`requests.status`)

| –°—Ç–∞—Ç—É—Å | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|--------|
| `NEW` | –ó–∞—è–≤–∫–∞ –ø–æ–ª—É—á–µ–Ω–∞ –∏ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞ –≤ –≥—Ä—É–ø–ø–µ |
| `ASSIGNED` | –°–æ—Ç—Ä—É–¥–Ω–∏–∫ –ø—Ä–∏–Ω—è–ª –∑–∞—è–≤–∫—É |
| `IN_PROGRESS` | –ó–∞—è–≤–∫–∞ –≤ —Ä–∞–±–æ—Ç–µ |
| `APPROVED` | –†–µ—à–µ–Ω–∏–µ KA ‚Äî –æ–¥–æ–±—Ä–µ–Ω–æ |
| `REJECTED` | –†–µ—à–µ–Ω–∏–µ KA ‚Äî –æ—Ç–∫–∞–∑ |
| `CALLBACK_PENDING` | –†–µ—à–µ–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–æ, –Ω–æ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ 1F |
| `DONE` | –£—Å–ø–µ—à–Ω–æ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –≤ 1F |
| `ERROR_GROUP` | –û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ Telegram |
| `ERROR_ONEF` | –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ 1F |

---

## üß© –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

### 1Ô∏è‚É£ –ü—É–±–ª–∏–∫–∞—Ü–∏—è –∑–∞—è–≤–∫–∏
- –∑–∞—è–≤–∫–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç –∏–∑ 1F
- —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î
- –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è –≤ Telegram-–≥—Ä—É–ø–ø–µ —Å –∫–Ω–æ–ø–∫–æ–π **Accept**

---

### 2Ô∏è‚É£ Accept (–≥—Ä—É–ø–ø–∞)
- –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
- —Å—Ç–∞—Ç—É—Å: `NEW ‚Üí ASSIGNED`
- –∫–Ω–æ–ø–∫–∞ Accept —É–±–∏—Ä–∞–µ—Ç—Å—è
- –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—é –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ª–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

---

### 3Ô∏è‚É£ –í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É (–ª–∏—á–∫–∞)
- –∫–Ω–æ–ø–∫–∞ **–ü—Ä–∏–Ω—è—Ç—å –∑–∞—è–≤–∫—É**
- —Å—Ç–∞—Ç—É—Å: `ASSIGNED ‚Üí IN_PROGRESS`
- –≥—Ä—É–ø–ø–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
- –ø–æ—è–≤–ª—è–µ—Ç—Å—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞: **–ü–µ—Ä–µ–¥–∞—Ç—å –ê–õ / –û—Ç–∫–ª–æ–Ω–∏—Ç—å**

---

### 4Ô∏è‚É£ Approve / Reject
- –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
- —Å—Ç–∞—Ç—É—Å:
  - `IN_PROGRESS ‚Üí APPROVED`
  - `IN_PROGRESS ‚Üí REJECTED`
- —Å—Ç–∞—Ç—É—Å —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è `CALLBACK_PENDING`
- —Å–æ–∑–¥–∞—ë—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ `audit_log`

---

### 5Ô∏è‚É£ –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ 1F
- HTTP POST –≤ 1F
- –ø—Ä–∏ —É—Å–ø–µ—Ö–µ:
  - `CALLBACK_PENDING ‚Üí DONE`
  - `is_sent_to_1f = true`
- –ø—Ä–∏ –æ—à–∏–±–∫–µ:
  - `status = ERROR_ONEF`
  - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry

---

## üßæ Audit Log

–í—Å–µ –∫–ª—é—á–µ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü—É `audit_log`:

- ACCEPT
- IN_PROGRESS
- DECLINE_ASSIGNED
- DECISION
- ONEF_SENT
- ONEF_FAILED

---

## üõ†Ô∏è –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

- Python 3.12
- aiogram 3.x
- PostgreSQL
- SQLAlchemy (async)
- FSM (MemoryStorage)
- asyncio background tasks
- HTTP integration with 1F

---

## üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

asr_ka_bot/
‚îú‚îÄ‚îÄ handlers/
‚îú‚îÄ‚îÄ repo/
‚îú‚îÄ‚îÄ services/
‚îú‚îÄ‚îÄ states.py
‚îú‚îÄ‚îÄ middleware.py
‚îú‚îÄ‚îÄ db.py
‚îú‚îÄ‚îÄ models.py
‚îú‚îÄ‚îÄ main.py
‚îî‚îÄ‚îÄ README.md


---

## ‚öôÔ∏è –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```env
BOT_TOKEN=...
GROUP_CHAT_ID=...
DATABASE_URL=postgresql+asyncpg://...
ADMIN_IDS=1,2,3


üîÅ Retry-–º–µ—Ö–∞–Ω–∏–∑–º—ã

–û—à–∏–±–∫–∏ Telegram ‚Üí ERROR_GROUP ‚Üí –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞

–û—à–∏–±–∫–∏ 1F ‚Üí ERROR_ONEF ‚Üí –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞

üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

Accept –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º

–†–µ—à–µ–Ω–∏—è –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–π –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å

–£—Å—Ç–∞—Ä–µ–≤—à–∏–µ –∫–Ω–æ–ø–∫–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç

üë§ –ê–≤—Ç–æ—Ä

ASR Leasing
Internal Automation Team

